# Stage 1.6: CLI Enhancement — Обзор

## 1. Контекст

### 1.1. Текущее состояние (после Stage 1.5)

Stage 1.5 завершён. Реализована архитектура Ports & Adapters:

```
practiceraptor/
├── core/
│   ├── domain/          # User, Problem, Draft, Submission, Progress
│   ├── ports/           # IAuthProvider, ICodeExecutor, I*Repository
│   └── services/        # Чистые функции бизнес-логики
├── adapters/
│   ├── auth/            # AnonymousAuthProvider
│   ├── executors/       # LocalExecutor
│   └── storage/         # Json*Repository
└── di/                  # Config, Container, Providers
```

**Что работает:**
- Загрузка задач из JSON
- Выполнение кода в песочнице
- Сохранение Draft, Submission, Progress
- Базовая фильтрация задач

**Чего не хватает для полноценного CLI:**
- Пользовательские настройки (язык, фильтры по умолчанию)
- Сессионный механизм (кто текущий пользователь)
- CLI-специфичная конфигурация (редактор, тема)
- REPL-интерфейс с командами

### 1.2. Цель Stage 1.6

Превратить CLI из прототипа в **полноценный продукт**, сохраняя архитектурную чистоту и готовность к многопользовательской работе в будущих интерфейсах (Telegram, Web).

---

## 2. Архитектурная проблема

### 2.1. Разрыв между Core и CLI

Текущая модель `User` содержит только identity:

```python
@dataclass(frozen=True)
class User:
    id: str
    locale: str = "en"
    preferred_language: Language = Language.PYTHON
    created_at: datetime | None = None
```

Но для CLI нужны **настройки пользователя**:
- Язык программирования по умолчанию
- Язык интерфейса (locale)
- Фильтры задач по умолчанию (сложность, теги, статус)

И **CLI-специфичные настройки**:
- Редактор (vim, code, nano)
- Цветовая тема
- Автосохранение черновиков

### 2.2. Принцип разделения

```
┌─────────────────────────────────────────────────────────────────┐
│                         CORE (универсальный)                     │
│                                                                  │
│  User           = identity (id, created_at)                      │
│  UserSettings   = preferences (language, locale, filters)        │
│                                                                  │
│  Эти модели используются ВСЕМИ интерфейсами:                     │
│  CLI, Telegram Bot, Web                                          │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    CLI ADAPTER (специфичный)                     │
│                                                                  │
│  CLIConfig      = editor, theme, editor_args                     │
│  Session        = User + UserSettings + current state            │
│                                                                  │
│  Эти модели используются ТОЛЬКО в CLI                            │
└─────────────────────────────────────────────────────────────────┘
```

**Почему это важно:**
- Telegram Bot не нужен `editor` — он использует inline-ввод
- Web не нужна `theme` CLI — у него свой CSS
- Но **оба** используют `UserSettings.default_filters`

---

## 3. Планируемые изменения

### 3.1. Этап 1.6.1: Расширение доменной модели

**Добавляем в Core:**

| Компонент | Тип | Назначение |
|-----------|-----|------------|
| `TaskFilters` | Value Object | Фильтры задач (difficulty, tags, status) |
| `UserSettings` | Entity | Настройки пользователя |
| `ProblemListItem` | DTO | Задача + статус для отображения в списке |
| `IUserSettingsRepository` | Port | Интерфейс хранения настроек |

**Почему:**
- `TaskFilters` — переиспользуемый value object для фильтрации
- `UserSettings` — отделяет preferences от identity (SRP)
- `ProblemListItem` — объединяет Problem + Progress для UI
- `IUserSettingsRepository` — позволяет хранить настройки в JSON/SQLite/PostgreSQL

### 3.2. Этап 1.6.2: CLI Context & Bootstrap

**Добавляем в CLI Adapter:**

| Компонент | Тип | Назначение |
|-----------|-----|------------|
| `CLIConfig` | Config | CLI-специфичные настройки |
| `Session` | Runtime | Текущий пользователь + состояние |
| `CLIContext` | Runtime | Полный контекст для выполнения команд |
| `FileUserSettingsRepository` | Adapter | Хранение настроек в YAML-файлах |

**Почему:**
- `CLIConfig` — инкапсулирует всё CLI-специфичное
- `Session` — runtime-состояние текущей сессии
- `CLIContext` — единая точка доступа ко всем зависимостям
- `FileUserSettingsRepository` — реализация порта для CLI

### 3.3. Этап 1.6.3: CLI Commands (будущий)

Спецификация и реализация команд REPL.

### 3.4. Этап 1.6.4: REPL Implementation (будущий)

Реализация интерактивного режима.

---

## 4. Принципы изменений

### 4.1. Минимальные изменения существующего кода

Текущие модели (`Problem`, `Draft`, `Submission`, `Progress`) **не меняются**.
Текущие сервисы **не меняются**, только расширяются.

### 4.2. Обратная совместимость

Новые компоненты добавляются как **опциональные**.
Container получает новую зависимость, но существующий код продолжает работать.

### 4.3. Тестируемость

Каждый новый компонент покрывается unit-тестами.
Integration-тесты для цепочки инициализации.

---

## 5. Зависимости между этапами

```
┌─────────────────┐
│  Stage 1.6.1    │  Доменная модель (Core)
│  Domain         │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Stage 1.6.2    │  Контекст и инициализация (CLI Adapter)
│  Context        │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Stage 1.6.3    │  Спецификация команд
│  Commands Spec  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Stage 1.6.4    │  Реализация REPL
│  REPL           │
└─────────────────┘
```

---

## 6. Файлы документации

| Файл | Содержание |
|------|------------|
| `00_overview.md` | Этот документ — обзор и контекст |
| `01_domain_extension.md` | Этап 1.6.1 — расширение доменной модели |
| `02_cli_context_bootstrap.md` | Этап 1.6.2 — контекст и инициализация CLI |
| `03_cli_commands.md` | Этап 1.6.3 — спецификация команд (будущий) |
| `04_repl_implementation.md` | Этап 1.6.4 — реализация REPL (будущий) |

---

## 7. Критерии готовности Stage 1.6

- [ ] UserSettings и TaskFilters в доменной модели
- [ ] IUserSettingsRepository порт и адаптер
- [ ] CLIConfig и Session в CLI-адаптере
- [ ] Цепочка инициализации работает
- [ ] REPL с базовыми командами
- [ ] Тесты проходят
- [ ] Документация обновлена
